@using EliteRentals.Models.DTOs
@model IEnumerable<PropertyDto>
@{
    Layout = "_Layout";
    string q = Context.Request.Query["q"];

    string ImageOf(PropertyDto p)
    {
        var url  = p?.GetType().GetProperty("ImageUrl")?.GetValue(p)?.ToString();
        var path = p?.GetType().GetProperty("ImagePath")?.GetValue(p)?.ToString();
        var b64  = p?.GetType().GetProperty("ImageBase64")?.GetValue(p)?.ToString();

        if (!string.IsNullOrWhiteSpace(url))  return Url.Content(url);
        if (!string.IsNullOrWhiteSpace(path)) return Url.Content(path);
        if (!string.IsNullOrWhiteSpace(b64))  return $"data:image/jpeg;base64,{b64}";
        return Url.Content("~/images/placeholders/property.jpg"); // fallback
    }
}

<div class="container-fluid">
  <div class="row">
    <!-- Left sidebar -->
    <aside class="col-12 col-lg-3 col-xl-2 py-3">
      @{ try { await Html.RenderPartialAsync("_ManagerSidebar"); } catch { } }
    </aside>

    <!-- Main content -->
    <main class="col-12 col-lg-9 col-xl-10 py-3">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <h3 class="m-0">Properties</h3>
        <div class="d-flex gap-2">
          <form method="get" class="d-flex" role="search">
            <input name="q" value="@q" class="form-control" placeholder="Search title or description..." />
            <button class="btn btn-primary ms-2" type="submit">Search</button>
          </form>
          <a asp-action="AdminPropertyCreate" class="btn btn-success">+ Add Property</a>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:4rem;">#</th>
                <th style="width:7rem;">Image</th>
                <th>Title</th>
                <th>Description</th>
                <th class="text-end" style="width:8rem;">Rent</th>
                <th class="text-end" style="width:12rem;">Actions</th>
              </tr>
            </thead>
            <tbody>
              @if (Model == null || !Model.Any())
              {
                <tr><td colspan="6" class="text-center py-5 text-muted">No properties found.</td></tr>
              }
              else
              {
                var i = 1;
                foreach (var p in Model)
                {
                  <tr>
                    <td>@i</td>
                    <td>
                      <img src="@ImageOf(p)" alt="Property" class="rounded"
                           style="width:72px;height:72px;object-fit:cover;border:1px solid #eee;" />
                    </td>
                    <td class="fw-semibold">@p.Title</td>
                    <td class="text-truncate" style="max-width:520px;">@p.Description</td>
                    <td class="text-end">R @p.RentAmount.ToString("N0")</td>
                    <td class="text-end">
                      <div class="btn-group">
                        <a class="btn btn-outline-secondary btn-sm" asp-action="AdminPropertyView" asp-route-id="@p.PropertyId">View</a>
                        <a class="btn btn-outline-primary btn-sm" asp-action="AdminPropertyEdit" asp-route-id="@p.PropertyId">Edit</a>
                        <form asp-action="AdminPropertyDelete" asp-route-id="@p.PropertyId" method="post" class="d-inline">
                          @Html.AntiForgeryToken()
                          <button type="submit" class="btn btn-outline-danger btn-sm"
                                  onclick="return confirm('Delete this property?');">Delete</button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  i++;
                }
              }
            </tbody>
          </table>
        </div>
      </div>

      @if (TempData["AdminPropertyErr"] != null)
      { <div class="alert alert-danger mt-3">@TempData["AdminPropertyErr"]</div> }
      @if (TempData["AdminPropertyMsg"] != null)
      { <div class="alert alert-success mt-3">@TempData["AdminPropertyMsg"]</div> }
    </main>
  </div>
</div>

<style>
  /* Manager-like density + safe truncation */
  @@media (max-width: 1200px) { .table .text-truncate { max-width: 360px !important; } }
  @@media (max-width: 992px)  { .table .text-truncate { max-width: 260px !important; } }
</style>
